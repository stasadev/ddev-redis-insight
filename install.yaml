name: redis-insight

dependencies:
  - redis

project_files:
  - docker-compose.redis-insight.yaml
  - docker-compose.redis-insight_norouter.yaml
  - commands/host/redis-insight

ddev_version_constraint: '>= v1.24.3'

post_install_actions:
  - |
    #ddev-description:If router disabled, directly expose port
    if ( {{ contains "ddev-router" (list .DdevGlobalConfig.omit_containers | toString) }} ); then
      printf "#ddev-generated\nservices:\n  redis-insight:\n    ports:\n      - 5540:5540\n" > docker-compose.redis-insight_norouter.yaml
    fi
  - |
    #ddev-description:If Redis is optimized, set a password
    if [ $(ddev dotenv get .ddev/.env.redis --redis-optimized 2>/dev/null) = "true" ]; then
      printf "#ddev-generated\nservices:\n  redis-insight:\n    environment:\n      - REDIS_PASSWORD=redis\n" > docker-compose.redis-insight_password.yaml
    fi
  - |
    echo "You can now use 'ddev redis-insight' to launch Redis Insight UI"

removal_actions:
  - |
    #ddev-description:Remove docker-compose.redis-insight_password.yaml file
    file=docker-compose.redis-insight_password.yaml
    if [ -f "${file}" ]; then
      if grep -q '#ddev-generated' "${file}"; then
        rm -f "${file}"
      else
        echo "Unwilling to remove '$DDEV_APPROOT/.ddev/${file}' because it does not have #ddev-generated in it; you can manually delete it if it is safe to delete."
      fi
    fi
